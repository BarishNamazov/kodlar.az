---
import BaseLayout from "./BaseLayout.astro";
import Button from "../components/Button.astro";
import ActionButton from "../components/ActionButton.astro";
import Tag from "../components/Tag.astro";
import Icon from "../components/Icon.astro";
import Window from "../components/Window.astro";
import { getAuthor } from "../data/authors";
import { formatDateLong } from "../utils/styles";
import { Image } from "astro:assets";

interface Props {
  frontmatter: {
    title: string;
    author: string;
    date: Date;
    description: string;
    image?: string;
    categories: string[];
  };
  rawContent?: string;
}

const { frontmatter, rawContent = "" } = Astro.props;

const formattedDate = formatDateLong(frontmatter.date);

const wordCount = rawContent
  .split(/\s+/)
  .filter((word) => word.length > 0).length;
const readTime = Math.max(1, Math.ceil(wordCount / 200));

const authorData = getAuthor(frontmatter.author);
---

<BaseLayout
  title={`${frontmatter.title} | kodlar.az`}
  description={frontmatter.description}
>
  <div class="post-layout">
    <Window
      title={`${frontmatter.title.substring(0, 30)}${frontmatter.title.length > 30 ? "..." : ""}.md`}
      class="post-content"
    >
      <div class="post-body">
        <header class="post-header">
          <div class="header-line cmd-line">
            <span class="comment">---</span>
          </div>
          <div class="meta-block">
            <div class="meta-line">
              <span class="key">title:</span>
              <span class="string">"{frontmatter.title}"</span>
            </div>
            <div class="meta-line">
              <span class="key">author:</span>
              <a href={`/authors/${frontmatter.author}`} class="author-link"
                >"{authorData?.name || frontmatter.author}"</a
              >
            </div>
            <div class="meta-line">
              <span class="key">read_time:</span>
              <span class="value">{readTime} dəq</span>
            </div>
            <div class="meta-line">
              <span class="key">date:</span>
              <span class="value">{formattedDate}</span>
            </div>
            <div class="meta-line">
              <span class="key">categories:</span>
              <span class="array"
                >[
                {
                  frontmatter.categories.map((cat, i) => (
                    <>
                      <Tag
                        name={cat}
                        href={`/blogs?cat=${cat.toLowerCase()}`}
                      />
                      {i < frontmatter.categories.length - 1 && (
                        <span class="comma">, </span>
                      )}
                    </>
                  ))
                }
                ]</span
              >
            </div>
          </div>
          <div class="header-line cmd-line">
            <span class="comment">---</span>
          </div>
        </header>

        <div class="prose">
          <slot />
        </div>

        <footer class="post-footer">
          <div class="footer-left">
            <Button
              href="/blogs"
              variant="primary"
              icon="arrowLeft"
              iconSize={14}
            >
              məqalələr.list()
            </Button>
          </div>
          <div class="footer-right">
            <ActionButton icon="share" id="share-btn" title="Share" />
          </div>
        </footer>
      </div>
    </Window>

    <aside class="post-sidebar">
      <div class="sidebar-card">
        <h3><span class="comment">// </span>mündəricat</h3>
        <nav class="toc" id="toc">
          <!-- ToC will be generated by JS -->
        </nav>
      </div>

      <a
        href={`/authors/${frontmatter.author}`}
        class="sidebar-card author-card"
      >
        <div class="author-avatar">
          {
            authorData?.avatar ? (
              typeof authorData.avatar === "string" ? (
                <img src={authorData.avatar} alt={authorData.name} />
              ) : (
                <Image
                  src={authorData.avatar}
                  alt={authorData.name}
                  width={40}
                  height={40}
                />
              )
            ) : (
              <Icon name="user" size={20} />
            )
          }
        </div>
        <div class="author-info">
          <span class="author-label">// müəllif</span>
          <span class="author-name"
            >{authorData?.name || frontmatter.author}</span
          >
        </div>
      </a>
    </aside>
  </div>
</BaseLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const prose = document.querySelector(".prose");
    const toc = document.getElementById("toc");

    if (prose && toc) {
      const headings = prose.querySelectorAll("h2, h3");

      if (headings.length === 0) {
        toc.innerHTML = '<span class="no-toc">// başlıq yoxdur</span>';
        return;
      }

      headings.forEach((heading, index) => {
        const id = `heading-${index}`;
        heading.id = id;

        const link = document.createElement("a");
        link.href = `#${id}`;
        link.textContent = heading.textContent;
        link.className = `toc-link ${heading.tagName.toLowerCase() === "h3" ? "indent" : ""}`;

        toc.appendChild(link);
      });
    }

    // Share Button: Native share or copy link
    const shareBtn = document.getElementById("share-btn");
    if (shareBtn) {
      shareBtn.addEventListener("click", async () => {
        const url = window.location.href;
        const title = document.title;

        try {
          // Try native share first
          if (navigator.share) {
            await navigator.share({
              title: title,
              url: url,
            });
          } else {
            // Fallback to copy link
            await navigator.clipboard.writeText(url);

            // Change icon to checkmark with green color
            const icon = shareBtn.querySelector("svg");
            if (icon) {
              const originalHTML = icon.innerHTML;
              icon.innerHTML =
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
              shareBtn.classList.add("shared");

              // Revert after 2 seconds
              setTimeout(() => {
                icon.innerHTML = originalHTML;
                shareBtn.classList.remove("shared");
              }, 2000);
            }
          }
        } catch (err) {
          // User cancelled or error occurred
          console.error("Share error:", err);
        }
      });
    }
  });
</script>

<style>
  .post-layout {
    max-width: 1120px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 1.5rem;
  }

  .post-body {
    padding: 1.5rem;
  }

  /* Header */
  .post-header {
    margin-bottom: 2rem;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
  }

  .meta-block {
    padding: 0.75rem 0;
  }

  .meta-line {
    display: flex;
    gap: 0.5rem;
    padding: 0.25rem 0;
    flex-wrap: wrap;
    align-items: center;
  }

  .key {
    color: var(--color-purple);
  }
  .value {
    color: var(--color-cyan);
  }
  .array {
    color: var(--color-text-secondary);
  }
  .comma {
    color: var(--color-text-muted);
  }

  .author-link {
    color: var(--color-green);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .author-link:hover {
    color: var(--color-primary);
    text-decoration: underline;
  }

  /* Prose Content */
  .prose {
    line-height: 1.8;
    color: var(--color-text);
  }

  .prose :global(h2) {
    font-size: 1.375rem;
    font-weight: 600;
    margin: 2.5rem 0 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
    color: var(--color-text);
  }

  .prose :global(h2::before) {
    content: "## ";
    color: var(--color-text-muted);
    font-family: var(--font-mono);
  }

  .prose :global(h3) {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 1.5rem 0 0.75rem;
    color: var(--color-text);
  }

  .prose :global(h3::before) {
    content: "### ";
    color: var(--color-text-muted);
    font-family: var(--font-mono);
  }

  .prose :global(p) {
    margin-bottom: 1.25rem;
    color: var(--color-text-secondary);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
    color: var(--color-text-secondary);
  }

  .prose :global(li) {
    margin-bottom: 0.5rem;
  }

  .prose :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose :global(a:hover) {
    color: var(--color-primary-hover);
  }

  .prose :global(strong) {
    color: var(--color-text);
    font-weight: 600;
  }

  .prose :global(blockquote) {
    margin: 1.5rem 0;
    padding: 1rem 1.25rem;
    background: var(--color-surface);
    border-left: 3px solid var(--color-primary);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    color: var(--color-text-secondary);
    font-style: italic;
  }

  .prose :global(pre) {
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow-x: auto;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    line-height: 1.7;
  }

  .prose :global(code) {
    font-family: var(--font-mono);
  }

  .prose :global(:not(pre) > code) {
    background: var(--color-surface);
    color: var(--color-cyan);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-lg);
    margin: 1.5rem 0;
    border: 1px solid var(--color-border);
  }

  /* Post Footer */
  .post-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .footer-right {
    display: flex;
    gap: 0.5rem;
  }

  .action-btn.shared {
    color: var(--color-green);
  }

  /* Sidebar */
  .post-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: sticky;
    top: 5rem;
    height: fit-content;
  }

  /* ToC */
  .toc {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .toc :global(.toc-link) {
    display: block;
    padding: 0.375rem 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }

  .toc :global(.toc-link:hover) {
    background: var(--color-bg-secondary);
    color: var(--color-primary);
  }

  .toc :global(.toc-link.indent) {
    padding-left: 1rem;
    color: var(--color-text-muted);
    font-size: 0.625rem;
  }

  .toc :global(.no-toc) {
    font-family: var(--font-mono);
    font-size: 0.625rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  /* Author Card */
  a.author-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  a.author-card:hover {
    border-color: var(--color-green);
  }

  a.author-card:hover .author-name {
    color: var(--color-primary);
  }

  .author-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary-muted);
    color: var(--color-primary);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .author-info {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .author-label {
    font-family: var(--font-mono);
    font-size: 0.5625rem;
    color: var(--color-text-muted);
  }

  .author-name {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-green);
    transition: color var(--transition-fast);
  }

  @media (max-width: 1024px) {
    .post-layout {
      grid-template-columns: 1fr;
    }

    .post-sidebar {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
    }

    .sidebar-card {
      flex: 1;
      min-width: 180px;
    }
  }

  @media (max-width: 768px) {
    .post-sidebar {
      order: -1;
      flex-direction: column;
    }

    .post-body {
      padding: 1rem;
    }

    .prose :global(h2) {
      font-size: 1.25rem;
    }

    .prose :global(pre) {
      font-size: 0.75rem;
    }
  }
</style>
